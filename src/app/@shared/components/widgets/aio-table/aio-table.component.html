<app-page-layout>
  <ng-page-layout-header class="pb-16" fxLayout="column" fxLayoutAlign="center start">
    <div
      [class.container]="layoutCtrl.value === 'boxed'"
      [class.px-gutter]="layoutCtrl.value === 'fullwidth'"
      class="w-full flex flex-col sm:flex-row justify-between"
    >
      <div fxLayout="column" fxLayoutAlign="center">
        <h1 class="title mt-0 mb-1">{{ title }}</h1>
        <p class="opacity-50 mt-0 mb-1">{{ description }}</p>
      </div>
    </div>
  </ng-page-layout-header>

  <ng-page-layout-content
    [class.container]="layoutCtrl.value === 'boxed'"
    [class.px-gutter]="layoutCtrl.value === 'fullwidth'"
    class="-mt-6"
  >
    <div class="card overflow-auto -mt-16">
      <div
        class="bg-app-bar px-6 h-16 border-b sticky left-0"
        fxLayout="row"
        fxLayoutAlign="start center"
      >
        <h2
          class="title my-0 ltr:pr-4 rtl:pl-4 ltr:mr-4 rtl:ml-4 ltr:border-r rtl:border-l"
          fxFlex="none"
          fxHide.xs
        >
          <span *ngIf="selection.hasValue()"
            >{{ selection.selected.length }}
            {{ selection.selected.length > 1 ? tableName : tableNamePlural }}
            {{ 'general.selected' | translate }}</span
          >
        </h2>

        <div *ngIf="selection.hasValue()" class="mr-4 pr-4 border-r" fxFlex="none">
          <button
            *ngFor="let action of selectionActions"
            (click)="callAction(action, selection.selected)"
            color="primary"
            mat-icon-button
            matTooltip="{{ action.label }}"
            type="button"
            [ngClass]="action.cssClasses"
            [disabled]="!!action.loading"
            [class.spinner]="!!action.loading"
          >
            <mat-icon [icIcon]="action.icon"></mat-icon>
          </button>
        </div>

        <div
          class="bg-card rounded-full border px-4"
          fxFlex="400px"
          fxFlex.lt-md="auto"
          fxHide.xs
          fxLayout="row"
          fxLayoutAlign="start center"
        >
          <ic-icon [icIcon]="icSearch" size="20px"></ic-icon>
          <input
            (keyup.enter)="search($event.target.value)"
            [value]="query ? query : ''"
            class="px-4 py-3 border-0 outline-none w-full bg-transparent"
            placeholder="{{ 'general.search' | translate }} ..."
            type="search"
          />
        </div>

        <span fxFlex></span>

        <button class="ml-4" fxFlex="none" fxHide.gt-xs mat-icon-button type="button">
          <mat-icon [icIcon]="icSearch"></mat-icon>
        </button>

        <button
          *ngIf="moreActions && moreActions.length > 0"
          class="ml-4"
          fxFlex="none"
          mat-icon-button
          matTooltip="{{ 'general.more' | translate }}"
          type="button"
          [matMenuTriggerFor]="moreMenu"
        >
          <mat-icon [icIcon]="icMoreHoriz"></mat-icon>
        </button>

        <button
          *ngIf="filterControls && filterControls.length > 0"
          class="ml-4"
          fxFlex="none"
          mat-icon-button
          matTooltip="{{ 'general.filter' | translate }}"
          type="button"
          (click)="openFilterDialog()"
        >
          <mat-icon [icIcon]="icFilterList"></mat-icon>
        </button>

        <button
          *ngIf="createAction"
          (click)="callAction(createAction, null)"
          class="ml-4"
          color="primary"
          fxFlex="none"
          mat-mini-fab
          matTooltip="{{ 'general.add' | translate }} {{ tableName }}"
          type="button"
        >
          <mat-icon [icIcon]="icAdd"></mat-icon>
        </button>
      </div>

      <table @stagger [dataSource]="dataSource" class="w-full" mat-table>
        <!--- Note that these columns can be defined in any order.
              The actual rendered columns are set as a property on the row definition" -->

        <!-- Checkbox Column -->
        <ng-container
          matColumnDef="checkbox"
          *ngIf="selectionActions && selectionActions.length > 0"
        >
          <th *matHeaderCellDef mat-header-cell>
            <mat-checkbox
              (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              color="primary"
            >
            </mat-checkbox>
          </th>
          <td *matCellDef="let row" class="w-4" mat-cell>
            <mat-checkbox
              (change)="$event ? selection.toggle(row) : null"
              (click)="$event.stopPropagation()"
              [checked]="selection.isSelected(row)"
              color="primary"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Type Columns -->
        <ng-container *ngFor="let column of columns; trackBy: trackByProperty">
          <ng-container *ngIf="column.type === 'image'" [matColumnDef]="column.property">
            <th *matHeaderCellDef mat-header-cell></th>
            <td *matCellDef="let row" class="w-8 min-w-8 pr-0" mat-cell>
              <img
                [src]="getColumnValue(row, column.label)"
                class="avatar h-8 w-8 align-middle"
              />
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'text'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              {{ column.label | translate }}
            </th>
            <td *matCellDef="let row" mat-cell>
              <p class="content-overflow" [ngClass]="column.cssClasses">
                {{ getColumnValue(row, column.label) }}
              </p>
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'date'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              {{ column.label | translate }}
            </th>
            <td *matCellDef="let row" mat-cell>
              <p class="content-overflow" [ngClass]="column.cssClasses">
                {{
                  !!getColumnValue(row, column.label)
                    ? (getColumnValue(row, column.label) | date: 'longDate')
                    : '--'
                }}
              </p>
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'datetime'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              {{ column.label | translate }}
            </th>
            <td *matCellDef="let row" mat-cell>
              <p class="content-overflow" [ngClass]="column.cssClasses">
                {{
                  !!getColumnValue(row, column.label)
                    ? (getColumnValue(row, column.label) | date: 'medium')
                    : '--'
                }}
              </p>
            </td>
          </ng-container>

          <ng-container
            *ngIf="column.type === 'boolean'"
            [matColumnDef]="column.property"
          >
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              {{ column.label | translate }}
            </th>
            <td *matCellDef="let row" mat-cell>
              <p class="content-overflow" [ngClass]="column.cssClasses">
                {{ !!getColumnValue(row, column.label) ? '✅' : '❌' }}
              </p>
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'badge'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              {{ column.label | translate }}
            </th>
            <td *matCellDef="let row" mat-cell>
              <span class="badge content-overflow" [ngClass]="getCssClasses(column, row)">
                {{ getColumnValue(row, column.label) }}
              </span>
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'url'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              <p class="ltr:pl-4 rtl:pr-4">{{ column.label | translate }}</p>
            </th>
            <td *matCellDef="let row" mat-cell>
              <button
                (click)="openUrl($event, getColumnValue(row, column.label))"
                type="button"
                mat-button
                class="column-url"
              >
                <span>{{ 'general.open' | translate }}</span>
                <mat-icon
                  [icIcon]="icUrl"
                  class="text-base mt-2 ltr:ml-1 rtl:mr-1"
                ></mat-icon>
              </button>
            </td>
          </ng-container>

          <ng-container *ngIf="column.type === 'view'" [matColumnDef]="column.property">
            <th *matHeaderCellDef class="uppercase" mat-header-cell>
              <p class="ltr:pl-4 rtl:pr-4">{{ column.label }}</p>
            </th>
            <td *matCellDef="let row" mat-cell>
              <button
                (click)="viewUrl($event, getColumnValue(row, column.label))"
                type="button"
                mat-button
                class="column-url"
              >
                <span>View</span>
                <mat-icon
                  [icIcon]="icUrl"
                  class="text-base mt-2 ltr:ml-1 rtl:mr-1"
                ></mat-icon>
              </button>
            </td>
          </ng-container>
        </ng-container>

        <!-- Action Column -->
        <ng-container matColumnDef="actions" *ngIf="actions && actions.length > 0">
          <th *matHeaderCellDef mat-header-cell></th>
          <td *matCellDef="let row" class="w-10 text-secondary" mat-cell>
            <button
              (click)="$event.stopPropagation()"
              [matMenuTriggerData]="{ item: row }"
              [matMenuTriggerFor]="actionsMenu"
              mat-icon-button
              type="button"
            >
              <mat-icon [icIcon]="icMoreHoriz"></mat-icon>
            </button>
          </td>
        </ng-container>

        <tr *matHeaderRowDef="visibleColumns" mat-header-row></tr>
        <tr
          (click)="callAction(onClickAction, row)"
          *matRowDef="let row; columns: visibleColumns"
          @fadeInUp
          class="hover:bg-hover trans-ease-out cursor-pointer"
          mat-row
        ></tr>
      </table>

      <mat-paginator
        [pageSizeOptions]="pageSizeOptions"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        (page)="changePage($event)"
        class="sticky left-0"
      ></mat-paginator>
    </div>
  </ng-page-layout-content>
</app-page-layout>

<mat-menu #actionsMenu="matMenu" xPosition="before" yPosition="below">
  <ng-template
    *ngIf="dataSource && dataSource.data.length > 0 && actions && actions.length > 0"
    let-item="item"
    matMenuContent
  >
    <ng-template ngFor let-action [ngForOf]="actions">
      <button
        *ngIf="actionOnInit(action, item)"
        (click)="callAction(action, item)"
        [disabled]="action.loading || action.disabled"
        mat-menu-item
      >
        <mat-icon [icIcon]="action.icon"></mat-icon>
        <span>{{ action.label }}</span>
      </button>
    </ng-template>
  </ng-template>
</mat-menu>

<mat-menu #moreMenu="matMenu" xPosition="before" yPosition="below">
  <ng-template *ngIf="moreActions && moreActions.length > 0" matMenuContent>
    <ng-template ngFor let-action [ngForOf]="moreActions">
      <button
        *ngIf="actionOnInit(action, null)"
        (click)="callAction(action, null)"
        [disabled]="action.loading || action.disabled"
        mat-menu-item
      >
        <span>{{ action.label }}</span>
      </button>
    </ng-template>
  </ng-template>
</mat-menu>
